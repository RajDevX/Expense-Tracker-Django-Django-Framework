{% extends 'index.html' %}
{% block content %}
<div class="container-fluid">
  {% if status_message %}
    <div class="alert alert-info surface-card border-0 p-3 mb-4" role="alert">
      <i class="fa-solid fa-circle-info me-2"></i>{{ status_message }}
    </div>
  {% endif %}

  <section class="surface-card p-4 p-md-5 mb-4">
    <div class="row align-items-center g-4">
      <div class="col-lg-8">
        <span class="metric-chip">Monthly snapshot</span>
        <h1 class="display-6 page-heading mt-3 mb-2">Welcome back, {{ user_profile.uname }}!</h1>
        <p class="lead page-subtext mb-0">
          You are tracking {{ monthly_expense|default:0|floatformat:2 }} Rs in expenses and {{ monthly_income|default:0|floatformat:2 }} Rs in income for {{ current_month_label }}.
          Keep refining your budget to stay ahead.
        </p>
        <div class="d-flex flex-wrap gap-2 mt-3">
          <span class="badge bg-success text-uppercase text-white">
            <i class="fa-solid fa-wallet me-1"></i>
            Balance: {{ monthly_balance|floatformat:2 }}
          </span>
          <span class="badge btn-soft text-uppercase">
            <i class="fa-solid fa-bullseye me-1"></i>
            Savings: {% if monthly_income %}{{ savings_rate|floatformat:1 }}%{% else %}Add income{% endif %}
          </span>
          <span class="badge btn-soft text-uppercase">
            <i class="fa-solid fa-scale-balanced me-1"></i>
            Spend/Income: {% if monthly_income %}{{ expense_to_income_ratio|floatformat:1 }}%{% else %}--{% endif %}
          </span>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="p-3 rounded-4 bg-gradient" style="background: linear-gradient(135deg, rgba(91,75,255,0.2), rgba(34,211,238,0.2));">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <div class="text-uppercase fw-semibold small text-black-50">Budget usage</div>
              <div class="display-6 fw-bold text-black mt-1">{{ budget_usage }}%</div>
            </div>
            <i class="fa-solid fa-gauge-high text-white fs-1"></i>
          </div>
          <div class="progress budget-progress">
            <div class="progress-bar{% if remaining_budget < 0 %} bg-danger{% endif %}" role="progressbar" style="width: {{ budget_usage }}%;" aria-valuenow="{{ budget_usage }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="d-flex justify-content-between mt-2 text-white-50 small">
            <span>Budget: Rs {{ user_profile.monthly_budget|default:0|floatformat:2 }}</span>
            <span>Left: Rs {{ remaining_budget|default:0|floatformat:2 }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="row g-3 g-md-4 mt-2">
      <div class="col-md-auto">
        <a href="/Addincome" class="btn btn-success btn-icon">
          <i class="fa-solid fa-circle-plus"></i>
          Add income
        </a>
      </div>
      <div class="col-md-auto">
        <a href="/Addexpence" class="btn btn-danger btn-icon">
          <i class="fa-solid fa-circle-minus"></i>
          Add expense
        </a>
      </div>
      <div class="col-md-auto">
        <a href="/AllInCome" class="btn btn-outline-primary btn-icon">
          <i class="fa-solid fa-coins"></i>
          View incomes
        </a>
      </div>
      <div class="col-md-auto">
        <a href="/Allexpence" class="btn btn-outline-primary btn-icon">
          <i class="fa-solid fa-money-bill-wave"></i>
          View expenses
        </a>
      </div>
    </div>
  </section>

  <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4 g-4 mb-5">
    <div class="col">
      <div class="card surface-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase small fw-semibold text-muted mb-2">Monthly Income</p>
              <h3 class="mb-0 text-success">Rs {{ monthly_income|default:0|floatformat:2 }}</h3>
            </div>
            <span class="fs-2 text-success"><i class="fa-solid fa-arrow-trend-up"></i></span>
          </div>
          <p class="text-muted small mb-0 mt-3">Great! Your income inflow supports your savings journey.</p>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card surface-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase small fw-semibold text-muted mb-2">Monthly Expense</p>
              <h3 class="mb-0 text-danger">Rs {{ monthly_expense|default:0|floatformat:2 }}</h3>
            </div>
            <span class="fs-2 text-danger"><i class="fa-solid fa-arrow-trend-down"></i></span>
          </div>
          <p class="text-muted small mb-0 mt-3">Keep spending in check to stretch your monthly budget further.</p>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card surface-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase small fw-semibold text-muted mb-2">Monthly Balance</p>
              <h3 class="mb-0{% if monthly_balance < 0 %} text-danger{% else %} text-success{% endif %}">Rs {{ monthly_balance|floatformat:2 }}</h3>
            </div>
            <span class="fs-2{% if monthly_balance < 0 %} text-danger{% else %} text-success{% endif %}">
              <i class="fa-solid {% if monthly_balance < 0 %}fa-circle-down{% else %}fa-circle-up{% endif %}"></i>
            </span>
          </div>
          <p class="text-muted small mb-0 mt-3">
            {% if monthly_balance < 0 %}
              You're overspending this month. Trim expenses or increase income to recover.
            {% elif monthly_balance == 0 %}
              Balanced month so far. Keep logging entries to stay on track.
            {% else %}
              Awesome! You're ahead of plan—consider moving the surplus to savings.
            {% endif %}
          </p>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card surface-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase small fw-semibold text-muted mb-2">Remaining Budget</p>
              <h3 class="mb-0{% if remaining_budget < 0 %} text-danger{% else %} text-primary{% endif %}">Rs {{ remaining_budget|default:0|floatformat:2 }}</h3>
            </div>
            <span class="fs-2{% if remaining_budget < 0 %} text-danger{% else %} text-primary{% endif %}"><i class="fa-solid fa-piggy-bank"></i></span>
          </div>
          <p class="text-muted small mb-0 mt-3">Adjust the target below to reflect your latest plan.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-5">
    <div class="col-xl-4">
      <div class="card surface-card border-0 h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Action plan</h5>
          <span class="badge btn-soft text-uppercase">
            <i class="fa-solid fa-lightbulb me-1"></i>Tips
          </span>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0 small d-flex flex-column gap-3">
            {% if top_expense_category %}
              <li class="d-flex gap-3 align-items-start">
                <span class="badge bg-danger-subtle text-danger fw-semibold mt-1"><i class="fa-solid fa-list-ul"></i></span>
                <div>
                  <strong>Review {{ top_expense_category.label }}</strong>
                  <div class="text-muted">It's leading your spend this month at Rs {{ top_expense_category.value|floatformat:2 }}.</div>
                </div>
              </li>
            {% endif %}
            {% if monthly_balance < 0 %}
              <li class="d-flex gap-3 align-items-start">
                <span class="badge bg-danger text-uppercase mt-1"><i class="fa-solid fa-triangle-exclamation"></i></span>
                <div>
                  <strong>Balance is negative</strong>
                  <div class="text-muted">Log upcoming income or cut back discretionary expenses to recover.</div>
                </div>
              </li>
            {% else %}
              <li class="d-flex gap-3 align-items-start">
                <span class="badge bg-success text-uppercase mt-1"><i class="fa-solid fa-piggy-bank"></i></span>
                <div>
                  <strong>Capture your surplus</strong>
                  <div class="text-muted">Schedule a transfer to savings so extra cash doesn’t get spent.</div>
                </div>
              </li>
            {% endif %}
            {% if budget_usage > 80 %}
              <li class="d-flex gap-3 align-items-start">
                <span class="badge bg-warning text-uppercase mt-1"><i class="fa-solid fa-fire-flame-curved"></i></span>
                <div>
                  <strong>Budget almost used</strong>
                  <div class="text-muted">Freeze non-essential purchases until new income arrives.</div>
                </div>
              </li>
            {% else %}
              <li class="d-flex gap-3 align-items-start">
                <span class="badge bg-primary text-uppercase mt-1"><i class="fa-solid fa-calendar-check"></i></span>
                <div>
                  <strong>Log daily</strong>
                  <div class="text-muted">Consistent tracking keeps the dashboard predictive and insightful.</div>
                </div>
              </li>
            {% endif %}
            {% if monthly_income and savings_rate < 20 %}
              <li class="d-flex gap-3 align-items-start">
                <span class="badge bg-info text-uppercase mt-1"><i class="fa-solid fa-bullseye"></i></span>
                <div>
                  <strong>Boost savings rate</strong>
                  <div class="text-muted">Trim one recurring cost or up your income stream to cross 20%.</div>
                </div>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-xl-8">
      <div class="card surface-card border-0 h-100">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <h5 class="mb-0">All-time overview</h5>
            <small class="text-muted">Track the bigger picture alongside monthly insights.</small>
          </div>
          <button class="btn btn-outline-primary btn-sm btn-icon" type="button" disabled>
            <i class="fa-solid fa-download"></i>
            Export (soon)
          </button>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="border rounded-4 p-3 h-100">
                <p class="text-uppercase small fw-semibold text-muted mb-1">Totals tracked</p>
                <div class="d-flex flex-column gap-2">
                  <div class="d-flex justify-content-between">
                    <span>Total income</span>
                    <strong class="text-success">Rs {{ total_income|default:0|floatformat:2 }}</strong>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Total expense</span>
                    <strong class="text-danger">Rs {{ total_expense|default:0|floatformat:2 }}</strong>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Net position</span>
                    <strong class="{% if net_total < 0 %}text-danger{% else %}text-success{% endif %}">
                      Rs {{ net_total|floatformat:2 }}
                    </strong>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="border rounded-4 p-3 h-100">
                <p class="text-uppercase small fw-semibold text-muted mb-1">This month pacing</p>
                <ul class="list-unstyled small mb-0 d-flex flex-column gap-2">
                  <li class="d-flex justify-content-between">
                    <span>Budget set</span>
                    <strong>Rs {{ user_profile.monthly_budget|default:0|floatformat:2 }}</strong>
                  </li>
                  <li class="d-flex justify-content-between">
                    <span>Spent so far</span>
                    <strong class="text-danger">Rs {{ monthly_expense|default:0|floatformat:2 }}</strong>
                  </li>
                  <li class="d-flex justify-content-between">
                    <span>Remaining</span>
                    <strong class="{% if remaining_budget < 0 %}text-danger{% else %}text-success{% endif %}">
                      Rs {{ remaining_budget|default:0|floatformat:2 }}
                    </strong>
                  </li>
                  <li class="d-flex justify-content-between">
                    <span>Usage</span>
                    <strong>{{ budget_usage|floatformat:1 }}%</strong>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-lg-3 g-4 mb-5">
    <div class="col">
      <div class="card surface-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase small fw-semibold text-muted mb-2">Savings Rate</p>
              {% if monthly_income %}
                <h3 class="mb-0{% if savings_rate < 0 %} text-danger{% else %} text-success{% endif %}">{{ savings_rate|floatformat:2 }}%</h3>
              {% else %}
                <h3 class="mb-0 text-muted">--</h3>
              {% endif %}
            </div>
            <span class="badge btn-soft text-uppercase">
              <i class="fa-solid fa-umbrella-beach me-1"></i>Goal
            </span>
          </div>
          <p class="text-muted small mb-3">
            {% if monthly_income %}
              {% if savings_rate < 0 %}
                You're dipping into reserves. Look for quick wins to cut costs.
              {% elif savings_rate < 20 %}
                A positive start. Aim for 20%+ to grow your buffer.
              {% else %}
                Fantastic saving pace—keep the momentum going!
              {% endif %}
            {% else %}
              Add income entries to see how much of it you're keeping.
            {% endif %}
          </p>
          <div class="progress budget-progress mb-1" style="height: 0.45rem;">
            <div class="progress-bar{% if savings_rate < 0 %} bg-danger{% else %} bg-success{% endif %}"
                 role="progressbar"
                 style="width: {{ savings_rate_clamped|floatformat:0 }}%"
                 aria-valuenow="{{ savings_rate }}"
                 aria-valuemin="0"
                 aria-valuemax="100"></div>
          </div>
          <small class="text-muted d-block">Target: 20% savings each month.</small>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card surface-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase small fw-semibold text-muted mb-2">Expense-to-Income</p>
              {% if monthly_income %}
                <h3 class="mb-0{% if expense_to_income_ratio > 70 %} text-danger{% else %} text-success{% endif %}">
                  {{ expense_to_income_ratio|floatformat:2 }}%
                </h3>
              {% else %}
                <h3 class="mb-0 text-muted">--</h3>
              {% endif %}
            </div>
            <span class="badge btn-soft text-uppercase">
              <i class="fa-solid fa-scale-balanced me-1"></i>Ratio
            </span>
          </div>
          <p class="text-muted small mb-3">
            {% if monthly_income %}
              {% if expense_to_income_ratio > 100 %}
                Spending exceeds income—prioritise essentials and pause extras.
              {% elif expense_to_income_ratio > 70 %}
                You're close to the edge. Track recurring spends carefully.
              {% else %}
                Healthy gap between inflow and outflow. Maintain the discipline!
              {% endif %}
            {% else %}
              Log income to understand how much spending it supports.
            {% endif %}
          </p>
          <div class="d-flex align-items-center justify-content-between small text-muted">
            <span>Safe zone &lt;= 70%</span>
            {% if monthly_income %}
              <span>Current: {{ expense_to_income_ratio|floatformat:1 }}%</span>
            {% else %}
              <span>Log income to calculate ratio</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card surface-card border-0 h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="text-uppercase small fw-semibold text-muted mb-2">Category Highlights</p>
              <h3 class="h5 mb-0">Where money moves</h3>
            </div>
            <span class="badge bg-primary text-uppercase">
              <i class="fa-solid fa-sparkles me-1"></i>Focus
            </span>
          </div>
          <ul class="list-unstyled small mb-0">
            <li class="d-flex align-items-start gap-2 mb-2">
              <i class="fa-solid fa-arrow-trend-down text-danger mt-1"></i>
              {% if top_expense_category %}
                <div>
                  <strong>{{ top_expense_category.label }}</strong>
                  <div class="text-muted">Largest expense: Rs {{ top_expense_category.value|floatformat:2 }}</div>
                </div>
              {% else %}
                <span class="text-muted">Add expenses to see which category dominates.</span>
              {% endif %}
            </li>
            <li class="d-flex align-items-start gap-2">
              <i class="fa-solid fa-arrow-trend-up text-success mt-1"></i>
              {% if top_income_category %}
                <div>
                  <strong>{{ top_income_category.label }}</strong>
                  <div class="text-muted">Main income driver: Rs {{ top_income_category.value|floatformat:2 }}</div>
                </div>
              {% else %}
                <span class="text-muted">Add income entries to highlight your top source.</span>
              {% endif %}
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 align-items-stretch mb-5">
    <div class="col-xl-5">
      <div class="card surface-card border-0 h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">Monthly Budget</h5>
            <small class="text-muted">Update the amount you aim to spend this month.</small>
          </div>
          <span class="badge bg-primary bg-opacity-10 text-primary-emphasis">
            <i class="fa-solid fa-pen-to-square me-1"></i>Edit
          </span>
        </div>
        <div class="card-body">
          <form method="post" class="row g-3" novalidate>
            {% csrf_token %}
            <div class="col-12">
              <label for="monthly_budget" class="form-label fw-semibold text-muted">Budget amount (Rs)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="monthly_budget" name="monthly_budget" value="{{ user_profile.monthly_budget|default:0 }}">
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100 shadow-sm" type="submit">
                <i class="fa-solid fa-floppy-disk me-2"></i>Save Budget
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-xl-7">
      <div class="card surface-card border-0 h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">Monthly Summary</h5>
            <small class="text-muted">Visual breakdown of your {{ current_month_label }} finances.</small>
          </div>
          <div class="metric-chip text-uppercase">Insights</div>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <h6 class="fw-semibold text-muted small mb-2">Expense Split</h6>
              {% if expense_category_breakdown %}
                <canvas id="expenseBreakdownChart" height="240"></canvas>
              {% else %}
                <div class="text-center text-muted py-5 bg-light rounded-4">
                  <i class="fa-regular fa-chart-pie fs-3 mb-2 d-block"></i>
                  Add expenses to see your spending mix.
                </div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <h6 class="fw-semibold text-muted small mb-2">Income vs Expense</h6>
              {% if income_vs_expense_values|length > 0 %}
                <canvas id="incomeExpenseChart" height="240"></canvas>
              {% else %}
                <div class="text-center text-muted py-5 bg-light rounded-4">
                  <i class="fa-regular fa-circle-question fs-3 mb-2 d-block"></i>
                  Add entries to compare inflow against spending.
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card surface-card border-0 h-100">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-danger-subtle text-danger rounded-pill">
              <i class="fa-solid fa-receipt"></i>
            </span>
            <div>
              <h5 class="mb-0">Recent Expenses</h5>
              <small class="text-muted">Your last {% if recent_expenses %}{{ recent_expenses|length }}{% else %}0{% endif %} logs</small>
            </div>
          </div>
          <a class="btn btn-sm btn-outline-primary btn-icon" href="/Allexpence">
            <i class="fa-solid fa-arrow-up-right-from-square"></i>
            View all
          </a>
        </div>
        <div class="card-body">
          {% if recent_expenses %}
            <ul class="list-group list-group-flush">
              {% for item in recent_expenses %}
                <li class="list-group-item px-0 py-3 d-flex justify-content-between align-items-start bg-transparent gap-3">
                  <div class="d-flex gap-3">
                    <span class="badge badge-expense align-self-start">
                      <i class="fa-solid fa-receipt"></i>
                    </span>
                    <div>
                      <div class="fw-semibold">{{ item.remark }}</div>
                      <small class="text-muted">{{ item.date }} at {{ item.time }} &bull; {{ item.category|title }}</small>
                    </div>
                  </div>
                  <span class="badge badge-expense">-Rs {{ item.amount|floatformat:2 }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-center text-muted py-4">
              <p class="mb-3">No expenses recorded yet.</p>
              <div class="d-inline-flex gap-2">
                <a href="/Addexpence" class="btn btn-danger btn-sm btn-icon">
                  <i class="fa-solid fa-circle-plus"></i>
                  Add expense
                </a>
                <a href="/AllInCome" class="btn btn-outline-primary btn-sm btn-icon">
                  <i class="fa-solid fa-coins"></i>
                  View incomes
                </a>
              </div>
            </div>
          {% endif %}
        </div>
        <div class="card-footer border-0 d-flex justify-content-between align-items-center text-muted small">
          <span>Tracked this month: <strong class="text-danger">Rs {{ monthly_expense|default:0|floatformat:2 }}</strong></span>
          <a href="/Addexpence" class="btn btn-soft btn-sm btn-icon">
            <i class="fa-solid fa-plus"></i>
            Log expense
          </a>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card surface-card border-0 h-100">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-success-subtle text-success rounded-pill">
              <i class="fa-solid fa-sack-dollar"></i>
            </span>
            <div>
              <h5 class="mb-0">Recent Income</h5>
              <small class="text-muted">Latest {% if recent_incomes %}{{ recent_incomes|length }}{% else %}0{% endif %} inflows</small>
            </div>
          </div>
          <a class="btn btn-sm btn-outline-primary btn-icon" href="/AllInCome">
            <i class="fa-solid fa-arrow-up-right-from-square"></i>
            View all
          </a>
        </div>
        <div class="card-body">
          {% if recent_incomes %}
            <ul class="list-group list-group-flush">
              {% for item in recent_incomes %}
                <li class="list-group-item px-0 py-3 d-flex justify-content-between align-items-start bg-transparent gap-3">
                  <div class="d-flex gap-3">
                    <span class="badge badge-income align-self-start">
                      <i class="fa-solid fa-sack-dollar"></i>
                    </span>
                    <div>
                      <div class="fw-semibold">{{ item.remark }}</div>
                      <small class="text-muted">{{ item.date }} at {{ item.time }} &bull; {{ item.category|title }}</small>
                    </div>
                  </div>
                  <span class="badge badge-income">Rs {{ item.amount|floatformat:2 }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-center text-muted py-4">
              <p class="mb-3">No income entries yet.</p>
              <div class="d-inline-flex gap-2">
                <a href="/Addincome" class="btn btn-success btn-sm btn-icon">
                  <i class="fa-solid fa-circle-plus"></i>
                  Add income
                </a>
                <a href="/Allexpence" class="btn btn-outline-primary btn-sm btn-icon">
                  <i class="fa-solid fa-money-bill-wave"></i>
                  View expenses
                </a>
              </div>
            </div>
          {% endif %}
        </div>
        <div class="card-footer border-0 d-flex justify-content-between align-items-center text-muted small">
          <span>Logged this month: <strong class="text-success">Rs {{ monthly_income|default:0|floatformat:2 }}</strong></span>
          <a href="/Addincome" class="btn btn-soft btn-sm btn-icon">
            <i class="fa-solid fa-plus"></i>
            Log income
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  {% if expense_category_breakdown %}
    {{ expense_category_breakdown|json_script:"expense-breakdown-data" }}
  {% endif %}
  {% if income_vs_expense_values %}
    {{ income_vs_expense_values|json_script:"income-expense-data" }}
  {% endif %}
  <script>
    (function () {
      const palette = [
        "#6366F1",
        "#22D3EE",
        "#F97316",
        "#A855F7",
        "#F43F5E",
        "#0EA5E9",
        "#84CC16"
      ];

      const datasetFromScript = (id) => {
        const el = document.getElementById(id);
        if (!el) return null;
        try {
          return JSON.parse(el.textContent);
        } catch (error) {
          console.error("Failed to parse chart data", error);
          return null;
        }
      };

      const expenseData = datasetFromScript("expense-breakdown-data");
      if (expenseData && expenseData.length && window.Chart) {
        const ctx = document.getElementById("expenseBreakdownChart");
        if (ctx) {
          new Chart(ctx, {
            type: "pie",
            data: {
              labels: expenseData.map(item => item.label),
              datasets: [{
                data: expenseData.map(item => item.value),
                backgroundColor: palette,
                borderColor: "#0F172A",
                borderWidth: 1
              }]
            },
            options: {
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    color: "#0f172a",
                    usePointStyle: true
                  }
                }
              }
            }
          });
        }
      }

      const incomeExpenseData = datasetFromScript("income-expense-data");
      if (incomeExpenseData && incomeExpenseData.length && window.Chart) {
        const ctx = document.getElementById("incomeExpenseChart");
        if (ctx) {
          new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: incomeExpenseData.map(item => item.label),
              datasets: [{
                data: incomeExpenseData.map(item => item.value),
                backgroundColor: [palette[0], palette[2]],
                borderColor: "#0F172A",
                borderWidth: 1,
                hoverOffset: 6
              }]
            },
            options: {
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    color: "#0f172a",
                    usePointStyle: true
                  }
                }
              }
            }
          });
        }
      }
    })();
  </script>
{% endblock %}
